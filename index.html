<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cabin Pressurization + O₂ Trainer</title>
<style>
  :root{
    --bg:#0e1116;
    --panel:#151a22;
    --ink:#e6ebf2;
    --muted:#9aa4b2;
    --accent:#66d9e8;
    --green:#33d17a;
    --yellow:#f6c644;
    --orange:#ff9933;
    --red:#ff5d5d;
    --card:#0f131a;
    --border:#242b36;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  h1,h2,h3{margin:0 0 .5rem}
  h1{font-size:1.25rem;letter-spacing:.2px}
  h2{font-size:1.05rem;color:var(--muted);font-weight:600}
  h3{font-size:.95rem;color:var(--muted);font-weight:600}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:16px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:8px}
  label{font-size:.9rem;color:var(--muted)}
  input[type="range"]{width:100%}
  input[type="number"],select{
    width:100%; background:var(--card); color:var(--ink);
    border:1px solid var(--border); border-radius:8px; padding:8px;
  }
  .small{font-size:.85rem;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .kv{display:grid;grid-template-columns:1fr auto;gap:6px;margin:6px 0}
  .kv .k{color:var(--muted)}
  .kv .v{font-variant-numeric:tabular-nums}
  .band{border-radius:8px;padding:10px 12px;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .chip{border-radius:999px;padding:2px 10px;border:1px solid var(--border);background:rgba(255,255,255,0.03)}
  .risk-min{background:rgba(51,209,122,.1)}
  .risk-low{background:rgba(102,217,232,.08)}
  .risk-mod{background:rgba(246,198,68,.12)}
  .risk-inc{background:rgba(255,153,51,.12)}
  .risk-high{background:rgba(255,93,93,.12)}
  .btn{
    background:linear-gradient(180deg,#1f2733,#18202b);
    color:var(--ink); border:1px solid var(--border); border-radius:10px;
    padding:8px 12px; cursor:pointer;
  }
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .row.wrap > *{flex:1 1 180px}
  .help{color:var(--muted);font-size:.85rem}
  .divider{height:1px;background:var(--border);margin:10px 0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  @media (max-width:1050px){ .cols-3{grid-template-columns:1fr} .cols-2{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="align-items:flex-end;justify-content:space-between">
      <div>
        <h1>Cabin Pressurization + O₂ Trainer</h1>
        <div class="small">Model pressurization behavior, continuous-flow O₂ delivery, Henry’s law, and DCS tissue ratio risk.</div>
      </div>
      <div class="row">
        <button id="btnStart" class="btn">Start</button>
        <button id="btnPause" class="btn ghost" disabled>Pause</button>
        <button id="btnResetTissue" class="btn ghost">Reset Tissue to Equilibrium</button>
      </div>
    </div>

    <div class="grid cols-3" style="margin-top:16px">
      <!-- Aircraft / Pressurization -->
      <div class="panel stack">
        <h2>Aircraft and Pressurization</h2>
        <div class="stack">
          <label>Aircraft Type</label>
          <select id="aircraftType">
            <option value="commercial">Commercial airliner</option>
            <option value="tactical">Tactical jet</option>
            <option value="custom">Custom</option>
          </select>
          <div class="help">Sets defaults for max ΔP, cabin altitude cap, and pressurization start.</div>
        </div>

        <div class="stack">
          <label>Aircraft Altitude (ft)</label>
          <input id="acAlt" type="range" min="0" max="50000" step="100" value="0" />
          <input id="acAltNum" type="number" min="0" max="50000" step="100" value="0" />
        </div>

        <div class="stack">
          <label>Pressurization Starts Above (ft)</label>
          <input id="pressStart" type="range" min="0" max="20000" step="500" />
          <input id="pressStartNum" type="number" min="0" max="20000" step="100" />
          <div class="help">Below this altitude, cabin = ambient (no pressurization).</div>
        </div>

        <div class="stack">
          <label>Max Differential Pressure ΔP (psi)</label>
          <input id="dpMax" type="range" min="2" max="10" step="0.1" />
          <input id="dpMaxNum" type="number" min="2" max="10" step="0.1" />
          <div class="help">Upper limit: cabin pressure ≤ ambient + ΔP.</div>
        </div>

        <div class="stack">
          <label>Cabin Altitude Cap (ft)</label>
          <input id="capAlt" type="range" min="6000" max="20000" step="500" />
          <input id="capAltNum" type="number" min="6000" max="20000" step="100" />
          <div class="help">Target “at most” cabin altitude when ΔP allows.</div>
        </div>
      </div>

      <!-- O2 Delivery -->
      <div class="panel stack">
        <h2>O₂ Delivery (Continuous Flow)</h2>
        <div class="stack">
          <label>O₂ Flow (L/min)</label>
          <input id="o2Flow" type="range" min="0" max="15" step="0.1" value="0" />
          <input id="o2FlowNum" type="number" min="0" max="15" step="0.1" value="0" />
        </div>
        <div class="stack">
          <label>Minute Ventilation (L/min)</label>
          <input id="ve" type="range" min="4" max="30" step="0.5" value="8" />
          <input id="veNum" type="number" min="4" max="30" step="0.5" value="8" />
          <div class="help">Approximate effective alveolar mixing driver.</div>
        </div>
        <div class="stack">
          <label>Mask Efficiency (0–1)</label>
          <input id="eff" type="range" min="0" max="1" step="0.05" value="0.8" />
          <input id="effNum" type="number" min="0" max="1" step="0.05" value="0.8" />
          <div class="help">Delivery effectiveness (seal, fit, rebreathing).</div>
        </div>
        <div class="stack">
          <label>Baseline Cabin FiO₂</label>
          <input id="fio2Cabin" type="range" min="0.2095" max="0.5" step="0.0005" value="0.2095" />
          <input id="fio2CabinNum" type="number" min="0.2095" max="0.5" step="0.0005" value="0.2095" />
          <div class="help">Assume dry air unless special mix.</div>
        </div>
      </div>

      <!-- Tissue Model -->
      <div class="panel stack">
        <h2>Tissue N₂ Kinetics</h2>
        <div class="stack">
          <label>Compartment Half-time (min)</label>
          <input id="tHalf" type="range" min="5" max="240" step="5" value="40" />
          <input id="tHalfNum" type="number" min="5" max="240" step="5" value="40" />
          <div class="help">Single-compartment exponential approach to PiN₂.</div>
        </div>
        <div class="stack">
          <label>Sim Speed (x real-time)</label>
          <input id="simSpeed" type="range" min="1" max="120" step="1" value="60" />
          <input id="simSpeedNum" type="number" min="1" max="120" step="1" value="60" />
        </div>
        <div class="stack">
          <label>Initialize Tissue State</label>
          <div class="row">
            <button id="btnSetSeaLevel" class="btn ghost">Set to Sea-Level Equilibrium</button>
            <button id="btnSetCurrentEq" class="btn ghost">Set to Current Equilibrium</button>
          </div>
          <div class="help">Sea-level eq uses dry air baseline; Current eq uses computed PiN₂ now.</div>
        </div>
      </div>
    </div>

    <!-- Outputs -->
    <div class="grid cols-3" style="margin-top:16px">
      <div class="card">
        <h2>Environment</h2>
        <div class="kv"><div class="k">Aircraft Altitude</div><div class="v"><span id="outAcAlt" class="mono">0</span> ft</div></div>
        <div class="kv"><div class="k">Ambient Pressure</div><div class="v"><span id="outPAmb" class="mono">760.0</span> mmHg</div></div>
        <div class="divider"></div>
        <div class="kv"><div class="k">Cabin Altitude</div><div class="v"><span id="outCabAlt" class="mono">0</span> ft</div></div>
        <div class="kv"><div class="k">Cabin Pressure</div><div class="v"><span id="outPCab" class="mono">760.0</span> mmHg</div></div>
        <div class="kv"><div class="k">ΔP (cabin − ambient)</div><div class="v"><span id="outDP" class="mono">0.0</span> psi</div></div>
      </div>

      <div class="card">
        <h2>Inspired Gases (Tracheal)</h2>
        <div class="kv"><div class="k">Effective FiO₂</div><div class="v"><span id="outFiO2" class="mono">0.2095</span></div></div>
        <div class="kv"><div class="k">PiO₂</div><div class="v"><span id="outPiO2" class="mono">0.0</span> mmHg</div></div>
        <div class="kv"><div class="k">PiN₂</div><div class="v"><span id="outPiN2" class="mono">0.0</span> mmHg</div></div>
        <div class="kv"><div class="k">Henry’s Law: Relative Dissolved N₂</div><div class="v"><span id="outHenry" class="mono">1.00</span> × sea-level</div></div>
        <div class="small">Relative dissolved N₂ scales with inspired N₂ partial pressure (educational visualization).</div>
      </div>

      <div class="card">
        <h2>Tissue N₂ + DCS Risk</h2>
        <div class="kv"><div class="k">Tissue PN₂</div><div class="v"><span id="outTissueN2" class="mono">0.0</span> mmHg</div></div>
        <div class="kv"><div class="k">Tissue Ratio (TR = PN₂ / Pambient)</div><div class="v"><span id="outTR" class="mono">1.00</span></div></div>
        <div id="riskBand" class="band risk-min">
          <div>
            <div class="small">DCS Risk Band</div>
            <div id="riskLabel" class="mono">Minimal</div>
          </div>
          <div class="chip mono" id="riskRange">&lt; 1.0</div>
        </div>
        <div class="small" style="margin-top:8px">
          Educational bands based on decompression theory: <span class="mono">&lt;1.0</span> Minimal; <span class="mono">1.0–1.5</span> Low; <span class="mono">1.5–2.0</span> Moderate; <span class="mono">2.0–2.5</span> Increased; <span class="mono">&gt;2.5</span> High.
        </div>
      </div>
    </div>

    <!-- Legend / Notes -->
    <div class="panel" style="margin-top:16px">
      <h2>Notes</h2>
      <ul>
        <li><strong>Pressurization:</strong> Cabin pressure is the minimum of sea-level pressure, ambient+ΔP, and a target pressure (derived from the selected cabin altitude cap). Below the pressurization start altitude, cabin equals ambient.</li>
        <li><strong>Continuous-flow O₂:</strong> Effective FiO₂ is computed by mixing baseline cabin FiO₂ with O₂ flow scaled by minute ventilation and mask efficiency.</li>
        <li><strong>Tissue kinetics:</strong> Single-compartment exponential approach to inspired PiN₂ with adjustable half-time and real-time simulation.</li>
        <li><strong>Henry’s law:</strong> Relative dissolved N₂ index uses PiN₂ normalized to sea-level inspired N₂.</li>
        <li><strong>DCS banding:</strong> TR cutoffs: &lt;1.0 Minimal; 1.0–1.5 Low; 1.5–2.0 Moderate; 2.0–2.5 Increased; &gt;2.5 High.</li>
      </ul>
    </div>
  </div>

<script>
(function(){
  // Physical constants
  const P0_Pa = 101325;           // Sea-level pressure
  const T0 = 288.15;              // K
  const L = 0.0065;               // K/m
  const g = 9.80665;              // m/s^2
  const M = 0.0289644;            // kg/mol
  const R = 8.31447;              // J/(mol*K)
  const PA_TO_MMHG = 0.00750061683;
  const PSI_TO_MMHG = 51.7149326;
  const PH2O = 47.0;              // mmHg, water vapor pressure at body temp

  // Elements
  const el = id => document.getElementById(id);

  const aircraftType = el('aircraftType');
  const acAlt = el('acAlt'), acAltNum = el('acAltNum');
  const pressStart = el('pressStart'), pressStartNum = el('pressStartNum');
  const dpMax = el('dpMax'), dpMaxNum = el('dpMaxNum');
  const capAlt = el('capAlt'), capAltNum = el('capAltNum');

  const o2Flow = el('o2Flow'), o2FlowNum = el('o2FlowNum');
  const ve = el('ve'), veNum = el('veNum');
  const eff = el('eff'), effNum = el('effNum');
  const fio2Cabin = el('fio2Cabin'), fio2CabinNum = el('fio2CabinNum');

  const tHalf = el('tHalf'), tHalfNum = el('tHalfNum');
  const simSpeed = el('simSpeed'), simSpeedNum = el('simSpeedNum');

  const btnStart = el('btnStart'), btnPause = el('btnPause'), btnResetTissue = el('btnResetTissue');
  const btnSetSeaLevel = el('btnSetSeaLevel'), btnSetCurrentEq = el('btnSetCurrentEq');

  const outAcAlt = el('outAcAlt'), outPAmb = el('outPAmb');
  const outCabAlt = el('outCabAlt'), outPCab = el('outPCab'), outDP = el('outDP');
  const outFiO2 = el('outFiO2'), outPiO2 = el('outPiO2'), outPiN2 = el('outPiN2'), outHenry = el('outHenry');
  const outTissueN2 = el('outTissueN2'), outTR = el('outTR');
  const riskBand = el('riskBand'), riskLabel = el('riskLabel'), riskRange = el('riskRange');

  // State
  let running = false;
  let lastTS = performance.now();
  let tissuePN2 = 0; // mmHg
  let seaLevelPiN2 = 0; // baseline for Henry's law normalization

  // Utilities
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const ftToM = ft => ft * 0.3048;
  const mToFt = m => m / 0.3048;

  function pressureAtAltitude_mmHg(alt_ft){
    const h = ftToM(alt_ft);
    const P = P0_Pa * Math.pow(1 - (L*h)/T0, (g*M)/(R*L));
    return P * PA_TO_MMHG;
  }
  function altitudeFromPressure_ft_mmHg(P_mmHg){
    const P = P_mmHg / PA_TO_MMHG;
    const exponent = (R*L)/(g*M);
    const term = Math.pow(P/P0_Pa, exponent);
    const h = (T0/L) * (1 - term);
    return Math.max(0, mToFt(h));
  }

  // Bind twin inputs
  function bindTwin(range, number, onChange){
    const sync = () => { number.value = range.value; onChange(); };
    const syncNum = () => { range.value = number.value; onChange(); };
    range.addEventListener('input', sync);
    number.addEventListener('input', syncNum);
  }

  // Defaults per aircraft type
  function setAircraftDefaults(){
    const type = aircraftType.value;
    if(type==='commercial'){
      pressStart.value = pressStartNum.value = 0;          // starts immediately
      dpMax.value = dpMaxNum.value = 8.6;                  // psi
      capAlt.value = capAltNum.value = 8000;               // ft
    } else if(type==='tactical'){
      pressStart.value = pressStartNum.value = 8000;       // ft
      dpMax.value = dpMaxNum.value = 5.0;                  // psi
      capAlt.value = capAltNum.value = 15000;              // ft
    } else {
      // keep user custom settings
    }
    computeAndRender();
  }

  // FiO2 effective with continuous flow
  function effectiveFiO2(Pcabin_mmHg){
    const base = parseFloat(fio2Cabin.value);
    const flow = parseFloat(o2Flow.value); // L/min
    const ventilation = Math.max(0.1, parseFloat(ve.value)); // L/min
    const eta = parseFloat(eff.value);
    // Simple educational mixer: fraction of breath replaced by O2 stream
    const frac = clamp((flow / ventilation) * eta, 0, 1);
    const fi = clamp(base + frac * (1 - base), 0, 1);
    return fi;
  }

  // Cabin pressure schedule
  function cabinPressure_mmHg(Pamb_mmHg){
    const startFt = parseFloat(pressStart.value);
    const dpPsi = parseFloat(dpMax.value);
    const capFt = parseFloat(capAlt.value);

    const acAltFt = parseFloat(acAlt.value);
    if(acAltFt < startFt){
      return Pamb_mmHg; // no pressurization yet
    }
    const Psea = pressureAtAltitude_mmHg(0);
    const Pcap = pressureAtAltitude_mmHg(capFt);

    // Candidate targets
    // We want cabin pressure as high as possible (lower cabin altitude) but within constraints:
    // Pcabin ≤ Psea; Pcabin ≤ Pamb + ΔP; Pcabin ≥ max(Pamb, Pcap)
    const upperByDP = Pamb_mmHg + dpPsi * PSI_TO_MMHG;
    const targetHigh = Math.min(Psea, upperByDP);
    const targetLow = Math.max(Pamb_mmHg, Pcap);
    const Pcabin = Math.max(targetLow, Math.min(targetHigh, Psea));
    return clamp(Pcabin, Pamb_mmHg, Psea);
  }

  function updateRisk(TR){
    let label='Minimal', range='< 1.0', cls='risk-min';
    if(TR < 1.0){ label='Minimal'; range='< 1.0'; cls='risk-min'; }
    else if(TR < 1.5){ label='Low'; range='1.0 – 1.5'; cls='risk-low'; }
    else if(TR < 2.0){ label='Moderate'; range='1.5 – 2.0'; cls='risk-mod'; }
    else if(TR < 2.5){ label='Increased'; range='2.0 – 2.5'; cls='risk-inc'; }
    else { label='High'; range='> 2.5'; cls='risk-high'; }
    riskBand.className = 'band ' + cls;
    riskLabel.textContent = label;
    riskRange.textContent = range;
  }

  function computeAndRender(dtSeconds = 0){
    // Inputs
    const acAltFt = parseFloat(acAlt.value);
    const Pamb = pressureAtAltitude_mmHg(acAltFt);
    const Pcabin = cabinPressure_mmHg(Pamb);
    const cabAltFt = altitudeFromPressure_ft_mmHg(Pcabin);

    // Gas mixing
    const FiO2 = effectiveFiO2(Pcabin);
    const PiO2 = Math.max(0, (Pcabin - PH2O) * FiO2);
    const FiN2 = clamp(1 - FiO2, 0, 1);
    const PiN2 = Math.max(0, (Pcabin - PH2O) * FiN2);

    // Tissue kinetics
    const half = Math.max(1, parseFloat(tHalf.value)); // min
    const k = Math.log(2) / (half * 60); // per second
    if(dtSeconds > 0){
      const e = Math.exp(-k * dtSeconds);
      tissuePN2 = tissuePN2 * e + PiN2 * (1 - e);
    } else if (!running && tissuePN2===0){
      // Initialize once at first render to sea-level equilibrium baseline
      const Psea = pressureAtAltitude_mmHg(0);
      const PiN2Sea = (Psea - PH2O) * (1 - parseFloat(fio2Cabin.value));
      tissuePN2 = PiN2Sea;
      seaLevelPiN2 = PiN2Sea;
    }

    const TR = Pamb > 0 ? (tissuePN2 / Pamb) : 0;

    // Henry’s law (relative dissolved N2)
    if(seaLevelPiN2 === 0){
      const Psea = pressureAtAltitude_mmHg(0);
      seaLevelPiN2 = (Psea - PH2O) * (1 - parseFloat(fio2Cabin.value));
    }
    const henryRel = seaLevelPiN2 > 0 ? (PiN2 / seaLevelPiN2) : 1;

    // Outputs
    outAcAlt.textContent = Math.round(acAltFt).toLocaleString();
    outPAmb.textContent = Pamb.toFixed(1);
    outCabAlt.textContent = Math.round(cabAltFt).toLocaleString();
    outPCab.textContent = Pcabin.toFixed(1);
    outDP.textContent = ((Pcabin - Pamb)/PSI_TO_MMHG).toFixed(2);

    outFiO2.textContent = FiO2.toFixed(4);
    outPiO2.textContent = PiO2.toFixed(1);
    outPiN2.textContent = PiN2.toFixed(1);
    outHenry.textContent = (henryRel).toFixed(2);

    outTissueN2.textContent = tissuePN2.toFixed(1);
    outTR.textContent = TR.toFixed(2);
    updateRisk(TR);
  }

  // Animation / sim loop
  function tick(ts){
    if(!running){ lastTS = ts; return; }
    const speed = parseFloat(simSpeed.value);
    const dtReal = (ts - lastTS) / 1000;
    const dtSim = dtReal * speed;
    lastTS = ts;
    computeAndRender(dtSim);
    requestAnimationFrame(tick);
  }

  // Bindings
  bindTwin(acAlt, acAltNum, () => computeAndRender());
  bindTwin(pressStart, pressStartNum, () => computeAndRender());
  bindTwin(dpMax, dpMaxNum, () => computeAndRender());
  bindTwin(capAlt, capAltNum, () => computeAndRender());

  bindTwin(o2Flow, o2FlowNum, () => computeAndRender());
  bindTwin(ve, veNum, () => computeAndRender());
  bindTwin(eff, effNum, () => computeAndRender());
  bindTwin(fio2Cabin, fio2CabinNum, () => {
    // Update sea-level baseline if user changes baseline FiO2 and tissue is still at initial state
    computeAndRender();
  });

  bindTwin(tHalf, tHalfNum, () => computeAndRender());
  bindTwin(simSpeed, simSpeedNum, () => computeAndRender());

  aircraftType.addEventListener('change', setAircraftDefaults);

  btnStart.addEventListener('click', ()=>{
    if(!running){
      running = true;
      btnStart.disabled = true;
      btnPause.disabled = false;
      lastTS = performance.now();
      requestAnimationFrame(tick);
    }
  });
  btnPause.addEventListener('click', ()=>{
    running = false;
    btnStart.disabled = false;
    btnPause.disabled = true;
  });
  btnResetTissue.addEventListener('click', ()=>{
    // Reset current tissue to current equilibrium PiN2
    const acAltFt = parseFloat(acAlt.value);
    const Pamb = pressureAtAltitude_mmHg(acAltFt);
    const Pcabin = cabinPressure_mmHg(Pamb);
    const FiO2 = effectiveFiO2(Pcabin);
    const PiN2 = Math.max(0, (Pcabin - PH2O) * (1 - FiO2));
    tissuePN2 = PiN2;
    computeAndRender();
  });
  btnSetSeaLevel.addEventListener('click', ()=>{
    const Psea = pressureAtAltitude_mmHg(0);
    const PiN2Sea = (Psea - PH2O) * (1 - parseFloat(fio2Cabin.value));
    tissuePN2 = PiN2Sea;
    seaLevelPiN2 = PiN2Sea;
    computeAndRender();
  });
  btnSetCurrentEq.addEventListener('click', ()=>{
    const acAltFt = parseFloat(acAlt.value);
    const Pamb = pressureAtAltitude_mmHg(acAltFt);
    const Pcabin = cabinPressure_mmHg(Pamb);
    const FiO2 = effectiveFiO2(Pcabin);
    const PiN2 = Math.max(0, (Pcabin - PH2O) * (1 - FiO2));
    tissuePN2 = PiN2;
    computeAndRender();
  });

  // Initialize defaults and first render
  setAircraftDefaults();
  computeAndRender();
})();
</script>
</body>
</html>
