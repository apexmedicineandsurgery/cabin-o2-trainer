<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cabin Pressurization + O₂ Trainer</title>
<style>
  :root{
    --bg:#0f1220;
    --panel:#151a2f;
    --accent:#6ee7ff;
    --accent2:#a2f39b;
    --warn:#ffb84d;
    --danger:#ff6b6b;
    --text:#e5e7ef;
    --muted:#9aa0b4;
    --good:#3ddc97;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--text); background:linear-gradient(180deg, #0c1020, #0a0d19);
  }
  header{
    padding:16px 20px; border-bottom:1px solid #202641; position:sticky; top:0; background:#0b0e1b; z-index:5;
  }
  header h1{margin:0; font-size:20px; letter-spacing:0.4px}
  header p{margin:6px 0 0; color:var(--muted); font-size:13px}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  .grid{display:grid; gap:16px; grid-template-columns: repeat(12, 1fr);}
  .card{background:var(--panel); border:1px solid #202641; border-radius:12px; padding:16px;}
  .span-12{grid-column: span 12}
  .span-8{grid-column: span 8}
  .span-6{grid-column: span 6}
  .span-4{grid-column: span 4}
  @media (max-width: 960px){ .span-8,.span-6,.span-4{grid-column: span 12} }
  h2{margin:0 0 8px 0; font-size:16px; color:#eaf0ff}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input[type=number], select, input[type=range]{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid #2a3157; background:#0f142a; color:var(--text);
    outline:none;
  }
  input[type=range]{padding:0; height:28px}
  .inline{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
  .kv{display:flex; align-items:baseline; gap:8px; margin:6px 0;}
  .mmhg{font-size:28px; font-weight:700; letter-spacing:0.3px;}
  .psi{font-size:13px; color:var(--muted);}
  .subtext{font-size:12px; color:var(--muted)}
  .badge{display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #2a3157; color:#b7c1ff;}
  .good{color:var(--good)}
  .warn{color:var(--warn)}
  .danger{color:var(--danger)}
  .accent{color:var(--accent)}
  .accent2{color:var(--accent2)}
  .divider{height:1px; background:#202641; margin:12px 0}
  .stack{display:grid; gap:8px}
  .muted{color:var(--muted)}
  .status-chip{
    display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; border:1px solid #2a3157; background:#0f142a; font-size:13px;
  }
  .row > div{flex:1; min-width:180px}
  .note{font-size:12px; color:var(--muted); margin-top:6px}
  .strong{font-weight:600}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
</style>
</head>
<body>
<header>
  <h1>Cabin Pressurization + O₂ Delivery Trainer</h1>
  <p>Realistic pressurization modes, mmHg-first display, sea-level O₂ comparators, mask overpressure teaching, and hypoxia alarms.</p>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Controls -->
    <section class="card span-12">
      <h2>Controls</h2>
      <div class="row">
        <div>
          <label for="alt_m">Aircraft altitude (m)</label>
          <input id="alt_m" type="number" value="0" min="0" max="30000" step="50" />
          <div class="inline"><span id="alt_ft">0 ft</span></div>
        </div>
        <div>
          <label for="press_profile">Pressurization mode</label>
          <select id="press_profile">
            <option value="failed" selected>Failed (cabin follows ambient)</option>
            <option value="jet">Jet Fighter (constant differential)</option>
            <option value="ramped">Commercial-style (constant pressure)</option>
          </select>
          <div class="inline"><span class="badge">ΔP limit enforced (active modes)</span></div>
        </div>
        <div>
          <label for="cabin_set_m">Cabin setpoint altitude (m)</label>
          <input id="cabin_set_m" type="number" value="2400" min="0" max="5000" step="50" />
          <div class="inline"><span id="cabin_set_ft">7,874 ft</span></div>
        </div>
        <div>
          <label for="dPmax_psi">Max ΔP (psi)</label>
          <input id="dPmax_psi" type="number" value="8" min="0" max="12" step="0.1" />
          <div class="inline muted">Typical fighter: 3-5 psi & transport: 7–9 psi</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <div>
          <label for="o2_mode">O₂ delivery mode</label>
          <select id="o2_mode">
            <option value="pressure">Pressure-demand (mask overpressure applied)</option>
            <option value="diluter">Diluter-demand (no overpressure)</option>
            <option value="flow">Continuous flow (no overpressure)</option>
          </select>
          <div class="inline muted">PIO₂/PAO₂ use cabin pressure plus mask overpressure in pressure‑demand mode.</div>
        </div>
        <div>
          <label for="fio2">O₂ fraction (FiO₂)</label>
          <input id="fio2" type="number" value="0.21" min="0.21" max="1.0" step="0.01" />
          <div class="inline"><span class="muted">0.21–1.00</span></div>
        </div>
        <div>
          <label for="mask_over_mmHg">Mask overpressure (mmHg)</label>
          <input id="mask_over_mmHg" type="number" value="0" min="0" max="200" step="1" />
          <div class="inline muted">Pressure-demand only</div>
        </div>
        <div>
          <label for="paco2">PaCO₂ (mmHg) · RQ</label>
          <div class="row">
            <div><input id="paco2" type="number" value="40" min="20" max="60" step="1" /></div>
            <div><input id="rq" type="number" value="0.8" min="0.7" max="1.0" step="0.05" /></div>
          </div>
          <div class="inline muted">Alveolar gas equation parameters</div>
        </div>
      </div>
    </section>

    <!-- Ambient -->
    <section class="card span-6">
      <h2>Ambient (aircraft)</h2>
      <div class="kv">
        <div class="mmhg" id="amb_mmhg">760.00 mmHg</div>
        <div class="psi" id="amb_psi">14.70 psi</div>
      </div>
      <div class="subtext">
        Altitude: <span id="amb_alt_m">0</span> m · <span id="amb_alt_ft2">0 ft</span>
      </div>
    </section>

    <!-- Cabin -->
    <section class="card span-6">
      <h2>Cabin</h2>
      <div class="kv">
        <div class="mmhg" id="cab_mmhg">760.00 mmHg</div>
        <div class="psi" id="cab_psi">14.70 psi</div>
      </div>
      <div class="subtext">
        Cabin altitude: <span id="cab_alt_m">0</span> m · <span id="cab_alt_ft">0 ft</span>
      </div>
      <div class="subtext">
        ΔP: <span id="cab_dp_psi">0.00 psi</span> (<span id="cab_dp_mmhg">0.00 mmHg</span>) · <span class="badge" id="segment_badge">At ambient</span>
      </div>
      <div class="note">Rule: cabin starts at ambient and only deviates when the profile demands and ΔP allows.</div>
    </section>

    <!-- O2 Partial Pressures + SpO2 + Hypoxia alarm -->
    <section class="card span-8">
      <h2>O₂ Partial Pressures</h2>
      <div class="stack">
        <div class="status-chip">
          <span class="mono">PIO₂</span>
          <span class="strong" id="pio2">149.0 mmHg</span>
          <span class="muted">Sea-level: 149 mmHg</span>
        </div>
        <div class="status-chip">
          <span class="mono">PAO₂</span>
          <span class="strong" id="pao2">100.0 mmHg</span>
          <span class="muted">Sea-level: 100 mmHg</span>
        </div>
        <div class="status-chip" id="spo2_chip">
          <span class="mono">SpO₂ (est)</span>
          <span class="strong" id="spo2_val">98 %</span>
          <span class="muted">Display estimate from PAO₂</span>
        </div>
        <div class="status-chip" id="hypoxia_chip" style="display:none">
          <span class="danger">HYPOXIA</span>
          <span>Increase FiO₂ or cabin pressure</span>
        </div>
        <div class="note">Calculations use cabin pressure plus mask overpressure when in pressure‑demand mode. PH₂O = 47 mmHg.</div>
      </div>
    </section>

    <!-- Mask Overpressure Teaching -->
    <section class="card span-4">
      <h2>Mask Overpressure Teaching</h2>
      <div id="mask_status" class="stack">
        <div class="status-chip"><span class="good">OK</span> <span class="muted">Comfortable breathing load</span></div>
      </div>
      <div class="divider"></div>
      <div class="stack">
        <div class="muted">Guidance without suit counter‑pressure:</div>
        <div class="stack">
          <div>• <span class="strong">≤ 20 mmHg</span>: sustainable for most.</div>
          <div>• <span class="strong">20–40 mmHg</span>: increased work of breathing.</div>
          <div>• <span class="strong">40–80 mmHg</span>: short‑term only; risk of CO₂ retention.</div>
          <div>• <span class="strong">> 80 mmHg (~1.5 psi)</span>: generally not ventilable without suit counter‑pressure.</div>
        </div>
      </div>
    </section>

    <!-- Henry’s Law + DCS -->
    <section class="card span-12">
      <h2>Henry’s Law + DCS Risk</h2>
      <div class="row">
        <div>
          <label for="n2_init_preset">Initial N₂ saturation preset</label>
          <select id="n2_init_preset">
            <option value="sea_air" selected>Sea level air (default)</option>
            <option value="custom">Custom (enter mmHg)</option>
          </select>
        </div>
        <div>
          <label for="n2_init_mmHg">Initial saturated N₂ pressure (mmHg)</label>
          <input id="n2_init_mmHg" type="number" value="563" min="0" max="1200" step="1" />
          <div class="inline muted">Default ≈ (760 − 47) × 0.79</div>
        </div>
      </div>
    
      <div class="divider"></div>
    
      <div class="row">
        <div class="status-chip">
          <span class="mono">Inspired N₂ (current)</span>
          <span class="strong" id="pn2_current">— mmHg</span>
        </div>
        <div class="status-chip">
          <span class="mono">Tissue Ratio</span>
          <span class="strong" id="tissue_ratio">—</span>
        </div>
        <div class="status-chip" id="dcs_risk_chip">
          <span class="badge">DCS risk: —</span>
        </div>
      </div>
    
      <div class="note">
        Risk thresholds are only based on Tissue Ratio and not M-Values and are illustrative only. Use the Air Force's ADRAC or NASA-specific models for real estimates on risk.
      </div>
    </section>

    
    <!-- Boyle’s law -->
    <section class="card span-12">
      <h2>Boyle’s Law (trapped gas volume)</h2>
      <div class="row">
        <div>
          <div class="status-chip">
            <span class="mono">Relative volume vs sea level (cabin)</span>
            <span class="strong" id="boyle_cabin">1.00 ×</span>
          </div>
        </div>
        <div>
          <div class="status-chip">
            <span class="mono">Relative volume vs sea level (ambient)</span>
            <span class="strong" id="boyle_ambient">1.00 ×</span>
          </div>
        </div>
      </div>
      <div class="note">Computed as P₀ / P, where P₀ = 760 mmHg.</div>
    </section>

    <!-- Footer notes -->
    <section class="span-12">
      <div class="note">
        Model: ISA (simplified to stratosphere), Dalton’s law, Boyle’s law, and the alveolar gas equation. Educational tool — values illustrative.
      </div>
    </section>

  </div>
</div>

<script>
  // ---------- Constants and helpers ----------
  const FT_PER_M = 3.280839895;
  function ft_to_m(feet) {
  return feet * 0.3048; // 1 ft = 0.3048 m
  }

  const PA_PER_PSI = 6894.75729;
  const PA_PER_MMHG = 133.3223684211;
  const P0_PA = 101325;
  const P0_MMHG = P0_PA / PA_PER_MMHG;

    // ---- Henry's law + DCS constants/helpers ----
  const PH2O_MMHG = 47; // Inspired water vapour pressure
  
  // Inspired N₂ partial pressure (mmHg) given total pressure & FiO₂
  function calcInspiredPN2_mmHg(Ptotal_mmHg, FiO2) {
    const FN2 = Math.max(0, 1 - FiO2);
    return Math.max(0, (Ptotal_mmHg - PH2O_MMHG) * FN2);
  }
  
  // Map Tissue Ratio to risk label + class
  function dcsRiskFromTR(TR) {
    if (!Number.isFinite(TR) || TR <= 0) return { label: "—", cls: "muted" };
    if (TR <= 1.00) return { label: "Minimal", cls: "good" };
    if (TR <= 1.50) return { label: "Low", cls: "accent2" };
    if (TR <= 2.00) return { label: "Moderate", cls: "warn" };
    if (TR <= 2.50) return { label: "Increased", cls: "danger" };
    return { label: "High", cls: "danger" };
  }

  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function fmt(n, d=2){ return Number.isFinite(n) ? n.toFixed(d) : "—"; }
  function fmtInt(n){ return Number.isFinite(n) ? Math.round(n).toLocaleString() : "—"; }
  function Pa_to_mmHg(Pa){ return Pa / PA_PER_MMHG; }
  function Pa_to_psi(Pa){ return Pa / PA_PER_PSI; }
  function psi_to_Pa(psi){ return psi * PA_PER_PSI; }

  // ISA pressure (troposphere to 11 km, isothermal to 20 km, extend with scale height)
  function isaPressurePa(alt_m){
    const g = 9.80665, R = 287.05287;
    const T0 = 288.15, L = 0.0065;
    if (alt_m <= 11000){
      return P0_PA * Math.pow(1 - (L*alt_m)/T0, g/(R*L));
    }
    const T11 = T0 - L*11000;
    const P11 = P0_PA * Math.pow(1 - (L*11000)/T0, g/(R*L));
    if (alt_m <= 20000){
      return P11 * Math.exp(-g*(alt_m-11000)/(R*T11));
    }
    const Tiso = 216.65;
    const P20 = P11 * Math.exp(-g*(20000-11000)/(R*T11));
    return P20 * Math.exp(-g*(alt_m-20000)/(R*Tiso));
  }

  function pressureToAltApprox_m(Pa){
    const g = 9.80665, R = 287.05287, T0 = 288.15, L = 0.0065;
    const P11 = isaPressurePa(11000);
    if (Pa >= P11){
      const ratio = Pa / P0_PA;
      const term = 1 - Math.pow(ratio, (R*L)/g);
      return (term * T0) / L;
    } else {
      const T11 = T0 - L*11000;
      return 11000 + (-R*T11/g) * Math.log(Pa / P11);
    }
  }

  // Pressurization modes
 function computeCabinPressurePa(airAlt_m, mode, cabinSet_m, dPmax_psi) {
  const Pamb = isaPressurePa(airAlt_m);
  const Pset = isaPressurePa(cabinSet_m);
  const dPmax_Pa = psi_to_Pa(dPmax_psi);
  const P0 = P0_PA; // ISA sea-level pressure

  let Pcabin, segment;

  // Fail-safe: cabin equals ambient
  if (mode === "failed") {
    return { Pcabin: Pamb, segment: "At ambient" };
  }

  // Existing fighter/jet schedule preserved
  if (mode === "jet") {
    const eightK_m = ft_to_m(8000);
    const P_8k = isaPressurePa(eightK_m);

    if (airAlt_m <= eightK_m) {
      Pcabin = Pamb;
      segment = "At ambient";
    } else if ((P_8k - Pamb) <= dPmax_Pa) {
      Pcabin = P_8k;
      segment = "Holding at 8k ft";
    } else {
      Pcabin = Pamb + dPmax_Pa;
      segment = "ΔP max (constant ΔP)";
    }
    return { Pcabin, segment };
  }

  // Commercial schedule (3 phases):
  // 1) From sea level, cabin pressure changes 1/4 as much as ambient (toward ambient),
  //    but never below the set-cabin pressure.
  const Pquarter = P0 + 0.25 * (Pamb - P0);     // quarter of ambient change from sea level
  const Pphase1 = Math.max(Pquarter, Pset);     // clamp: don't go below (i.e., more depressurized than) set

  // 2) Hold at set cabin pressure until ΔP hits the limit.
  // 3) If ΔP would exceed limit, switch to constant-ΔP (i.e., 1:1 with ambient changes).
  if ((Pphase1 - Pamb) > dPmax_Pa) {
    Pcabin = Pamb + dPmax_Pa;
    segment = "ΔP max (1:1 with ambient)";
  } else {
    Pcabin = Pphase1;
    segment = (Pcabin > Pset)
      ? "Quarter-track (1:4 to setpoint)"
      : "Holding at set cabin altitude";
  }

  return { Pcabin, segment };
  }


  // O2 calculations
  function calcPIO2_mmHg(Ptotal_mmHg, FiO2){ const PH2O = 47; return Math.max(0, (Ptotal_mmHg - PH2O) * FiO2); }
  function calcPAO2_mmHg(Ptotal_mmHg, FiO2, PaCO2, RQ){ return Math.max(0, calcPIO2_mmHg(Ptotal_mmHg, FiO2) - (PaCO2 / RQ)); }

  // Estimated SpO2 from PAO2 (illustrative sigmoid)
  function spo2FromPAO2(PAO2){
    const s = 100/(1+Math.exp(-(PAO2-55)/8));
    return clamp(s, 0, 100);
  }

  // Boyle’s relative volume vs sea level
  function boyleRelVolume(P_mmHg){ return (Number.isFinite(P_mmHg) && P_mmHg>0) ? (760 / P_mmHg) : NaN; }

  // Mask overpressure status
  function maskStatusLabel(over_mmHg, mode){
    if (mode !== "pressure" || over_mmHg <= 0){
      return { cls:"good", text:"No additional overpressure load" };
    }
    if (over_mmHg <= 20) return { cls:"good", text:"Comfortable breathing load" };
    if (over_mmHg <= 40) return { cls:"warn", text:"Increased work of breathing" };
    if (over_mmHg <= 80) return { cls:"warn", text:"Short‑term only; CO₂ retention risk" };
    return { cls:"danger", text:"Not ventilable without suit counter‑pressure" };
  }

  // ---------- DOM ----------
  const el = id => document.getElementById(id);

  function setDpMaxForMode(mode) {
    const dpInput = document.getElementById('dPmax_psi');
    if (!dpInput) return;
  
    let desiredPsi;
    if (mode === 'ramped')      desiredPsi = 8; // Commercial-style
    else if (mode === 'jet')    desiredPsi = 4; // Jet Fighter
    else desiredPsi = Number(dpInput.value) || 6; // Leave as-is for other modes
  
    dpInput.value = desiredPsi;
  }

  
  function update(){
    console.log("UPDATE CALLED — airAlt_m is", document.getElementById('alt_m').value);

    // Inputs
    const alt_m = clamp(parseFloat(el('alt_m').value), 0, 30000);
    const mode = el('press_profile').value;
    const cabinSet_m = clamp(parseFloat(el('cabin_set_m').value), 0, 5000);
    const dPmax_psi = clamp(parseFloat(el('dPmax_psi').value), 0, 20);

    const o2_mode = el('o2_mode').value;
    const FiO2 = clamp(parseFloat(el('fio2').value), 0.21, 1.0);
    const mask_over_mmHg = clamp(parseFloat(el('mask_over_mmHg').value), 0, 300);
    const PaCO2 = clamp(parseFloat(el('paco2').value), 20, 60);
    const RQ = clamp(parseFloat(el('rq').value), 0.7, 1.0);

    // Ambient
    const Pamb_Pa = isaPressurePa(alt_m);
    const Pamb_mmHg = Pa_to_mmHg(Pamb_Pa);
    const Pamb_psi = Pa_to_psi(Pamb_Pa);

    // Cabin
    const cab = computeCabinPressurePa(alt_m, mode, cabinSet_m, dPmax_psi);
    const Pcab_Pa = cab.Pcabin;
    const Pcab_mmHg = Pa_to_mmHg(Pcab_Pa);
    const Pcab_psi = Pa_to_psi(Pcab_Pa);
    const cab_alt_m = pressureToAltApprox_m(Pcab_Pa);
    const cab_alt_ft = cab_alt_m * FT_PER_M;

    // ΔP
    const dP_Pa = Math.max(0, Pcab_Pa - Pamb_Pa);
    const dP_psi = dP_Pa / PA_PER_PSI;
    const dP_mmhg = dP_Pa / PA_PER_MMHG;

    // Inspired total pressure for gas calcs
    let Pinspired_mmHg = Pcab_mmHg;
    if (o2_mode === "pressure") Pinspired_mmHg = Pcab_mmHg + mask_over_mmHg;

    // Gas/physiology
    const PIO2 = calcPIO2_mmHg(Pinspired_mmHg, FiO2);
    const PAO2 = calcPAO2_mmHg(Pinspired_mmHg, FiO2, PaCO2, RQ);
    const SpO2 = spo2FromPAO2(PAO2);

    // Boyle’s
    const boyleCab = boyleRelVolume(Pcab_mmHg);
    const boyleAmb = boyleRelVolume(Pamb_mmHg);

    // UI writes
    el('alt_ft').textContent = fmtInt(alt_m * FT_PER_M) + " ft";
    el('cabin_set_ft').textContent = fmtInt(cabinSet_m * FT_PER_M) + " ft";
    el('amb_alt_m').textContent = fmtInt(alt_m);
    el('amb_alt_ft2').textContent = fmtInt(alt_m * FT_PER_M) + " ft";

    el('amb_mmhg').textContent = fmt(Pamb_mmHg, 2) + " mmHg";
    el('amb_psi').textContent = fmt(Pamb_psi, 2) + " psi";

    el('cab_mmhg').textContent = fmt(Pcab_mmHg, 2) + " mmHg";
    el('cab_psi').textContent = fmt(Pcab_psi, 2) + " psi";
    el('cab_alt_m').textContent = fmtInt(cab_alt_m);
    el('cab_alt_ft').textContent = fmtInt(cab_alt_ft) + " ft";
    el('segment_badge').textContent = cab.segment;

    el('cab_dp_psi').textContent = fmt(dP_psi, 2) + " psi";
    el('cab_dp_mmhg').textContent = fmt(dP_mmhg, 2) + " mmHg";

    el('pio2').textContent = fmt(PIO2, 1) + " mmHg";
    el('pao2').textContent = fmt(PAO2, 1) + " mmHg";

    el('spo2_val').textContent = fmt(SpO2, 0) + " %";
    el('hypoxia_chip').style.display = (SpO2 < 90) ? "" : "none";

    el('boyle_cabin').textContent = fmt(boyleCab, 2) + " ×";
    el('boyle_ambient').textContent = fmt(boyleAmb, 2) + " ×";

    // Mask status
    const status = maskStatusLabel(mask_over_mmHg, o2_mode);
    el('mask_status').innerHTML = `<div class="status-chip"><span class="${status.cls.toLowerCase()}">${status.cls.toUpperCase()}</span> <span>${status.text}</span></div>` +
      ((o2_mode === "pressure" && mask_over_mmHg > 0)
        ? `<div class="muted">Mask overpressure: <span class="strong">${fmt(mask_over_mmHg, 0)} mmHg</span> (${fmt(mask_over_mmHg / 51.7149, 2)} psi)</div>`
        : `<div class="muted">No added mask pressure.</div>`
      );
    
    // ----- Henry's law + DCS (tissue N₂) -----
    const initPreset = document.getElementById('n2_init_preset').value;
    let N2_init_mmHg = parseFloat(document.getElementById('n2_init_mmHg').value);
    
    // Default sea-level saturation ≈ (760 − 47) × 0.79
    if (initPreset === 'sea_air' || !Number.isFinite(N2_init_mmHg)) {
      N2_init_mmHg = (760 - PH2O_MMHG) * 0.79;
    }
    
    // Current inspired N₂ — uses total pressure at the mask + FiO₂
    const PN2_current = calcInspiredPN2_mmHg(Pinspired_mmHg, FiO2);
    
    // Tissue Ratio (TR)
    const TR = N2_init_mmHg / PN2_current;
    
    // Map to risk band
    const risk = dcsRiskFromTR(TR);
    
    // ---- Write values into the new UI card ----
    document.getElementById('pn2_current').textContent = PN2_current.toFixed(1) + ' mmHg';
    document.getElementById('tissue_ratio').textContent = TR.toFixed(2);
    const riskChip = document.getElementById('dcs_risk_chip');
    riskChip.innerHTML = `<span class="${risk.cls}">DCS risk: ${risk.label}</span>`;
    } 

  // Mode change: set ΔP by mode, then recompute
  const modeSelect = document.getElementById('press_profile');
  if (modeSelect) {
    modeSelect.addEventListener('change', (e) => {
      setDpMaxForMode(e.target.value); // sets 8 psi for commercial-style, 4 psi for jet
      update();                         // recompute with the new ΔP
    });
  }

  // Wire inputs
  [ 'alt_m', 'cabin_set_m', 'dPmax_psi', 'o2_mode', 'fio2', 'mask_over_mmHg', 'paco2', 'rq' ].forEach(id => {
  const node = document.getElementById(id);
  node.addEventListener('input', update);
  node.addEventListener('change', update);
  });


  document.getElementById('n2_init_preset').addEventListener('input', update);
  document.getElementById('n2_init_mmHg').addEventListener('input', update);

  // Apply mode-specific ΔP before the first render
  (function initDpByMode() {
    const modeSel = document.getElementById('press_profile');
    if (modeSel) setDpMaxForMode(modeSel.value);
  })();

  // Initial render (defaults to Failed mode and FiO2 = 0.21)
  update();
</script>
</body>
</html>
```
