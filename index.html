<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cabin Pressurization + O₂ Trainer</title>
<style>
  :root{
    --bg:#0f1220;
    --panel:#151a2f;
    --accent:#6ee7ff;
    --accent2:#a2f39b;
    --warn:#ffb84d;
    --danger:#ff6b6b;
    --text:#e5e7ef;
    --muted:#9aa0b4;
    --good:#3ddc97;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--text); background:linear-gradient(180deg, #0c1020, #0a0d19);
  }
  header{
    padding:16px 20px; border-bottom:1px solid #202641; position:sticky; top:0; background:#0b0e1b; z-index:5;
  }
  header h1{margin:0; font-size:20px; letter-spacing:0.4px}
  header p{margin:6px 0 0; color:var(--muted); font-size:13px}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  .grid{display:grid; gap:16px; grid-template-columns: repeat(12, 1fr);}
  .card{background:var(--panel); border:1px solid #202641; border-radius:12px; padding:16px;}
  .span-12{grid-column: span 12}
  .span-8{grid-column: span 8}
  .span-6{grid-column: span 6}
  .span-4{grid-column: span 4}
  @media (max-width: 960px){ .span-8,.span-6,.span-4{grid-column: span 12} }
  h2{margin:0 0 8px 0; font-size:16px; color:#eaf0ff}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input[type=number], select, input[type=range]{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid #2a3157; background:#0f142a; color:var(--text);
    outline:none;
  }
  input[type=range]{padding:0; height:28px}
  .inline{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
  .kv{display:flex; align-items:baseline; gap:8px; margin:6px 0;}
  .mmhg{font-size:28px; font-weight:700; letter-spacing:0.3px;}
  .psi{font-size:13px; color:var(--muted);}
  .subtext{font-size:12px; color:var(--muted)}
  .badge{display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #2a3157; color:#b7c1ff;}
  .good{color:var(--good)}
  .warn{color:var(--warn)}
  .danger{color:var(--danger)}
  .accent{color:var(--accent)}
  .accent2{color:var(--accent2)}
  .divider{height:1px; background:#202641; margin:12px 0}
  .stack{display:grid; gap:8px}
  .muted{color:var(--muted)}
  .status-chip{
    display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; border:1px solid #2a3157; background:#0f142a; font-size:13px;
  }
  .row > div{flex:1; min-width:180px}
  .note{font-size:12px; color:var(--muted); margin-top:6px}
  .strong{font-weight:600}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

  /* NEW: Boyle's Law balloon animation */
  #boyleViz circle {
    transition: r 140ms ease-out;
  }

    /* NEW: DCS M Value Information */
  .compact th, .compact td { padding: 4px 8px; text-align: right; }
  .compact th:first-child, .compact td:first-child { text-align: left; }
  .risk-low  { background:#e6f7ec; color:#1e7f3f; padding:2px 6px; border-radius:4px; }
  .risk-med  { background:#fff6e6; color:#8a5a00; padding:2px 6px; border-radius:4px; }
  .risk-high { background:#ffebee; color:#b71c1c; padding:2px 6px; border-radius:4px; }

  
</style>
</head>
<body>
<header>
  <h1>Cabin Pressurization + O₂ Delivery Trainer</h1>
  <p>Realistic pressurization modes, mmHg-first display, sea-level O₂ comparators, mask overpressure teaching, and hypoxia alarms.</p>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Controls -->
    <section class="card span-12">
      <h2>Controls</h2>
      <div class="row">
        <div>
          <label for="alt_m">Aircraft altitude (m)</label>
          <input id="alt_m" type="number" value="0" min="0" max="30000" step="50" />
          <div class="inline"><span id="alt_ft">0 ft</span></div>
        </div>
        <div>
          <label for="press_profile">Pressurization mode</label>
          <select id="press_profile">
            <option value="failed" selected>Failed (cabin follows ambient)</option>
            <option value="jet">Jet Fighter (constant differential)</option>
            <option value="ramped">Commercial-style (constant pressure)</option>
          </select>
          <div class="inline"><span class="badge">ΔP limit enforced (active modes)</span></div>
        </div>
        <div>
          <label for="cabin_set_m">Cabin setpoint altitude (m)</label>
          <input id="cabin_set_m" type="number" value="1829" min="0" max="5000" step="50" />
          <div class="inline"><span id="cabin_set_ft">7,874 ft</span></div>
        </div>
        <div>
          <label for="dPmax_psi">Max ΔP (psi)</label>
          <input id="dPmax_psi" type="number" value="8" min="0" max="12" step="0.1" />
          <div class="inline muted">Typical fighter: 3-5 psi & transport: 7–9 psi</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <div>
          <label for="o2_mode">O₂ delivery mode</label>
          <select id="o2_mode">
            <option value="pressure">Pressure-demand (mask overpressure applied)</option>
            <option value="diluter">Diluter-demand (no overpressure)</option>
            <option value="flow">Continuous flow (no overpressure)</option>
          </select>
          <div class="inline muted">PIO₂/PAO₂ use cabin pressure plus mask overpressure in pressure‑demand mode.</div>
        </div>
        <div>
          <label for="fio2">O₂ fraction (FiO₂)</label>
          <input id="fio2" type="number" value="0.21" min="0.21" max="1.0" step="0.01" />
          <div class="inline"><span class="muted">0.21–1.00</span></div>
        </div>
        <div>
          <label for="mask_over_mmHg">Mask overpressure (mmHg)</label>
          <input id="mask_over_mmHg" type="number" value="0" min="0" max="200" step="1" />
          <div class="inline muted">Pressure-demand only</div>
        </div>
        <div>
          <label for="paco2">PaCO₂ (mmHg) · RQ</label>
          <div class="row">
            <div><input id="paco2" type="number" value="40" min="20" max="60" step="1" /></div>
            <div><input id="rq" type="number" value="0.8" min="0.7" max="1.0" step="0.05" /></div>
          </div>
          <div class="inline muted">Alveolar gas equation parameters</div>
        </div>
      </div>
    </section>

    <!-- Ambient -->
    <section class="card span-6">
      <h2>Ambient (aircraft)</h2>
      <div class="kv">
        <div class="mmhg" id="amb_mmhg">760.00 mmHg</div>
        <div class="psi" id="amb_psi">14.70 psi</div>
      </div>
      <div class="subtext">
        Altitude: <span id="amb_alt_m">0</span> m · <span id="amb_alt_ft2">0 ft</span>
      </div>
    </section>

    <!-- Cabin -->
    <section class="card span-6">
      <h2>Cabin</h2>
      <div class="kv">
        <div class="mmhg" id="cab_mmhg">760.00 mmHg</div>
        <div class="psi" id="cab_psi">14.70 psi</div>
      </div>
      <div class="subtext">
        Cabin altitude: <span id="cab_alt_m">0</span> m · <span id="cab_alt_ft">0 ft</span>
      </div>
      <div class="subtext">
        ΔP: <span id="cab_dp_psi">0.00 psi</span> (<span id="cab_dp_mmhg">0.00 mmHg</span>) · <span class="badge" id="segment_badge">At ambient</span>
      </div>
      <div class="note">Rule: cabin starts at ambient and only deviates when the profile demands and ΔP allows.</div>
    </section>

    <!-- O2 Partial Pressures + SpO2 + Hypoxia alarm -->
    <section class="card span-8">
      <h2>O₂ Partial Pressures</h2>
      <div class="stack">
        <div class="status-chip">
          <span class="mono">PIO₂</span>
          <span class="strong" id="pio2">149.0 mmHg</span>
          <span class="muted">Sea-level: 149 mmHg</span>
        </div>
        <div class="status-chip">
          <span class="mono">PAO₂</span>
          <span class="strong" id="pao2">100.0 mmHg</span>
          <span class="muted">Sea-level: 100 mmHg</span>
        </div>
        <div class="status-chip" id="spo2_chip">
          <span class="mono">SpO₂ (est)</span>
          <span class="strong" id="spo2_val">98 %</span>
          <span class="muted">Display estimate from PAO₂</span>
        </div>
        <div class="status-chip" id="hypoxia_chip" style="display:none">
          <span class="danger">HYPOXIA</span>
          <span>Increase FiO₂ or cabin pressure</span>
        </div>
        <div class="note">Calculations use cabin pressure plus mask overpressure when in pressure‑demand mode. PH₂O = 47 mmHg.</div>
      </div>
    </section>

    <!-- Mask Overpressure Teaching -->
    <section class="card span-4">
      <h2>Mask Overpressure Teaching</h2>
      <div id="mask_status" class="stack">
        <div class="status-chip"><span class="good">OK</span> <span class="muted">Comfortable breathing load</span></div>
      </div>
      <div class="divider"></div>
      <div class="stack">
        <div class="muted">Understanding Mask Overpressurization:</div>
        <div class="stack">
          <div>• <span class="strong">≤ 20 mmHg</span>: sustainable for most.</div>
          <div>• <span class="strong">20–40 mmHg</span>: increased work of breathing (>30 needs counter pressure vest to exhale).</div>
          <div>• <span class="strong">40–80 mmHg</span>: short‑term only; high risk of CO₂ retention.</div>
          <div>• <span class="strong">> 80 mmHg (~1.5 psi)</span>: generally not ventilable without suit counter‑pressure.</div>
        </div>
      </div>
    </section>

    <!-- Pre-breathe + Multi-Compartment DCS Risk (worst-case) -->
    <section class="card span-12">
      <h2>DCS Risk (Pre‑breathe + Multi‑Compartment M‑values)</h2>
    
      <div class="row">
        <div>
          <label for="n2_init_preset">Initial N₂ saturation preset</label>
          <select id="n2_init_preset">
            <option value="sea_air" selected>Sea level air (default)</option>
            <option value="custom">Custom (enter mmHg)</option>
          </select>
        </div>
        <div>
          <label for="n2_init_mmHg">Initial saturated N₂ pressure (mmHg)</label>
          <input id="n2_init_mmHg" type="number" value="563" min="0" max="1200" step="1" />
          <div class="inline muted">Default ≈ (760 − 47) × 0.79</div>
        </div>
        <div>
          <label for="prebreathe_min">Pre‑breathe (100% O₂ at sea level, minutes)</label>
          <input id="prebreathe_min" type="number" min="0" step="1" value="0" />
          <div class="inline muted">Worst‑case: tissues frozen after pre‑breathe; real off‑gassing in flight would reduce risk.</div>
        </div>
      </div>
    
      <div class="divider"></div>
    
      <table class="compact" style="margin-top:8px; width:100%;">
        <thead>
          <tr>
            <th>Half‑time</th>
            <th>Current PN₂</th>
            <th>M‑value</th>
            <th>Risk ratio</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="risk_tbody"></tbody>
      </table>
    </section>
    
    <!-- Boyle’s law -->
    <section class="card span-12">
      <h2>Boyle’s Law (trapped gas volume)</h2>
      <div class="row">
        <div>
          <div class="status-chip">
            <span class="mono">Relative volume vs sea level (cabin)</span>
            <span class="strong" id="boyle_cabin">1.00 ×</span>
          </div>
        </div>
        <div>
          <div class="status-chip">
            <span class="mono">Relative volume vs sea level (ambient)</span>
            <span class="strong" id="boyle_ambient">1.00 ×</span>
          </div>
        </div>
      </div>
    
      <!-- Boyle’s Law Visuals -->
      <div class="row" style="align-items:center; gap:2rem; margin-top:12px;">
        <svg id="boyleViz"
             viewBox="0 0 300 140"
             width="100%"
             height="160"
             preserveAspectRatio="xMidYMid meet"
             aria-label="Boyle's Law bubbles">
          <!-- Left: Cabin (dynamic) -->
          <circle id="cabinCircle"
                  cx="50" cy="60" r="32"
                  fill="rgba(74,144,226,0.12)"
                  stroke="#4a90e2"
                  stroke-width="2" />
      
          <!-- Middle: Sea level (fixed baseline) -->
          <circle id="baselineCircle"
                  cx="150" cy="60" r="32"
                  fill="none"
                  stroke="#888"
                  stroke-width="2"
                  stroke-dasharray="4,3" />
      
          <!-- Right: Ambient (dynamic) -->
          <circle id="ambientCircle"
                  cx="250" cy="60" r="32"
                  fill="rgba(255, 193, 7, 0.12)"
                  stroke="#ffb84d"
                  stroke-width="2" />
      
          <!-- Labels -->
          <g font-size="11" fill="var(--muted, #9aa3b2)">
            <text x="50"  y="120" text-anchor="middle">Cabin</text>
            <text x="150" y="120" text-anchor="middle">Sea level</text>
            <text x="250" y="120" text-anchor="middle">Ambient</text>
          </g>
        </svg>
      </div>


      
      <div class="note">Computed as P₀ / P, where P₀ = 760 mmHg.</div>
      </section>

    <!-- Footer notes -->
    <section class="span-12">
      <div class="note">
        Model: ISA (simplified to stratosphere), Dalton’s law, Boyle’s law, and the alveolar gas equation. Educational tool — values illustrative.
      </div>
    </section>

  </div>
</div>

<script>
  // ---------- Constants and helpers ----------
  const FT_PER_M = 3.280839895;
  function ft_to_m(feet) {
  return feet * 0.3048; // 1 ft = 0.3048 m
  }

  const PA_PER_PSI = 6894.75729;
  const PA_PER_MMHG = 133.3223684211;
  const P0_PA = 101325;
  const P0_MMHG = P0_PA / PA_PER_MMHG;

    // ---- Henry's law + DCS constants/helpers ----
  const PH2O_MMHG = 47; // Inspired water vapour pressure
  
  // Inspired N₂ partial pressure (mmHg) given total pressure & FiO₂
  function calcInspiredPN2_mmHg(Ptotal_mmHg, FiO2) {
    const FN2 = Math.max(0, 1 - FiO2);
    return Math.max(0, (Ptotal_mmHg - PH2O_MMHG) * FN2);
  }
  
  // Map Tissue Ratio to risk label + class
  function dcsRiskFromTR(TR) {
    if (!Number.isFinite(TR) || TR <= 0) return { label: "—", cls: "muted" };
    if (TR <= 1.00) return { label: "Minimal", cls: "good" };
    if (TR <= 1.50) return { label: "Low", cls: "accent2" };
    if (TR <= 2.00) return { label: "Moderate", cls: "warn" };
    if (TR <= 2.50) return { label: "Increased", cls: "danger" };
    return { label: "High", cls: "danger" };
  }

  // --- Boyle's Law visual updater ---
  function updateBoyleVisuals(relCabin, relAmbient) {
    const cabinEl    = document.getElementById("cabinCircle");
    const baselineEl = document.getElementById("baselineCircle");
    const ambientEl  = document.getElementById("ambientCircle");
    if (!cabinEl || !baselineEl || !ambientEl) return;
  
    // Sea-level bubble radius (must match the baselineCircle r in the SVG)
    const baseR = 32;
  
    // Clamp multipliers to avoid disappearing dots or runaway circles
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const vc = clamp(relCabin,   0.2, 6.0);
    const va = clamp(relAmbient, 0.2, 6.0);
  
    // Make circle AREA track “volume multiple” => radius ∝ sqrt(volume multiple)
    const rFromV = v => baseR * Math.sqrt(v);
  
    // Middle: fixed sea-level
    baselineEl.setAttribute("r", String(baseR));
  
    // Left: cabin (dynamic)
    cabinEl.setAttribute("r", String(rFromV(vc)));
  
    // Right: ambient (dynamic)
    ambientEl.setAttribute("r", String(rFromV(va)));
  }
  
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function fmt(n, d=2){ return Number.isFinite(n) ? n.toFixed(d) : "—"; }
  function fmtInt(n){ return Number.isFinite(n) ? Math.round(n).toLocaleString() : "—"; }
  function Pa_to_mmHg(Pa){ return Pa / PA_PER_MMHG; }
  function Pa_to_psi(Pa){ return Pa / PA_PER_PSI; }
  function psi_to_Pa(psi){ return psi * PA_PER_PSI; }

  // ISA pressure (troposphere to 11 km, isothermal to 20 km, extend with scale height)
  function isaPressurePa(alt_m){
    const g = 9.80665, R = 287.05287;
    const T0 = 288.15, L = 0.0065;
    if (alt_m <= 11000){
      return P0_PA * Math.pow(1 - (L*alt_m)/T0, g/(R*L));
    }
    const T11 = T0 - L*11000;
    const P11 = P0_PA * Math.pow(1 - (L*11000)/T0, g/(R*L));
    if (alt_m <= 20000){
      return P11 * Math.exp(-g*(alt_m-11000)/(R*T11));
    }
    const Tiso = 216.65;
    const P20 = P11 * Math.exp(-g*(20000-11000)/(R*T11));
    return P20 * Math.exp(-g*(alt_m-20000)/(R*Tiso));
  }

  function pressureToAltApprox_m(Pa){
    const g = 9.80665, R = 287.05287, T0 = 288.15, L = 0.0065;
    const P11 = isaPressurePa(11000);
    if (Pa >= P11){
      const ratio = Pa / P0_PA;
      const term = 1 - Math.pow(ratio, (R*L)/g);
      return (term * T0) / L;
    } else {
      const T11 = T0 - L*11000;
      return 11000 + (-R*T11/g) * Math.log(Pa / P11);
    }
  }

  // Pressurization modes
 function computeCabinPressurePa(airAlt_m, mode, cabinSet_m, dPmax_psi) {
  const Pamb = isaPressurePa(airAlt_m);
  const Pset = isaPressurePa(cabinSet_m);
  const dPmax_Pa = psi_to_Pa(dPmax_psi);
  const P0 = P0_PA; // ISA sea-level pressure

  let Pcabin, segment;

  // Fail-safe: cabin equals ambient
  if (mode === "failed") {
    return { Pcabin: Pamb, segment: "At ambient" };
  }

  // Existing fighter/jet schedule preserved
  if (mode === "jet") {
    const eightK_m = ft_to_m(8000);
    const P_8k = isaPressurePa(eightK_m);

    if (airAlt_m <= eightK_m) {
      Pcabin = Pamb;
      segment = "At ambient";
    } else if ((P_8k - Pamb) <= dPmax_Pa) {
      Pcabin = P_8k;
      segment = "Holding at 8k ft";
    } else {
      Pcabin = Pamb + dPmax_Pa;
      segment = "ΔP max (constant ΔP)";
    }
    return { Pcabin, segment };
  }

  // Commercial schedule (3 phases):
  // 1) From sea level, cabin pressure changes 1/4 as much as ambient (toward ambient),
  if (mode === "ramped") {
    const Pquarter = P0 + 0.5 * (Pamb - P0);
    const reachedSet = Pquarter <= Pset;

    if (!reachedSet) {
        Pcabin = Pquarter;
        segment = "Quarter-track (1:4 toward setpoint)";
    } else {
        const dP_now = Pset - Pamb;

        if (dP_now <= dPmax_Pa) {
            // Phase 2: hold at set cabin altitude *but check each loop*
            Pcabin = Pset;
            segment = "Holding at set cabin altitude";
        } else {
            Pcabin = Pamb + dPmax_Pa;
            segment = "ΔP max (constant ΔP)";
        }
    }
    return { Pcabin, segment };
  }
}



  // O2 calculations
  function calcPIO2_mmHg(Ptotal_mmHg, FiO2){ const PH2O = 47; return Math.max(0, (Ptotal_mmHg - PH2O) * FiO2); }
  function calcPAO2_mmHg(Ptotal_mmHg, FiO2, PaCO2, RQ){ return Math.max(0, calcPIO2_mmHg(Ptotal_mmHg, FiO2) - (PaCO2 / RQ)); }

  // Estimated SpO2 from PAO2 (illustrative sigmoid)
  function spo2FromPAO2(PAO2){
    const s = 100/(1+Math.exp(-(PAO2-55)/8));
    return clamp(s, 0, 100);
  }

  // Boyle’s relative volume vs sea level
  function boyleRelVolume(P_mmHg){ return (Number.isFinite(P_mmHg) && P_mmHg>0) ? (760 / P_mmHg) : NaN; }

  // Mask overpressure status
  function maskStatusLabel(over_mmHg, mode){
    if (mode !== "pressure" || over_mmHg <= 0){
      return { cls:"good", text:"No additional overpressure load" };
    }
    if (over_mmHg <= 20) return { cls:"good", text:"Comfortable breathing load" };
    if (over_mmHg <= 40) return { cls:"warn", text:"Increased work of breathing" };
    if (over_mmHg <= 80) return { cls:"warn", text:"Short‑term only; CO₂ retention risk" };
    return { cls:"danger", text:"Not ventilable without suit counter‑pressure" };
  }

  // ---------- DOM ----------
  const el = id => document.getElementById(id);

  function setDpMaxForMode(mode) {
    const dpInput = document.getElementById('dPmax_psi');
    if (!dpInput) return;
  
    let desiredPsi;
    if (mode === 'ramped')      desiredPsi = 9; // Commercial-style
    else if (mode === 'jet')    desiredPsi = 3; // Jet Fighter
    else desiredPsi = Number(dpInput.value) || 6; // Leave as-is for other modes
  
    dpInput.value = desiredPsi;
  }

  // --- Multi-compartment DCS model (worst-case) ---

    const MMHG_PER_BAR = 750.062; // 1 bar ≈ 750.062 mmHg
    const ln2 = Math.log(2);
    
    // Bühlmann ZHL-16C (N2) constants in bar (a) and unitless (b)
    const Models = {
      ZHL16C_N2: {
        name: "Bühlmann ZHL‑16C (N₂)",
        halfTimes_min: [4.0,5.0,8.0,12.5,18.5,27.0,38.3,54.3,77.0,109.0,146.0,187.0,239.0,305.0,390.0,498.0],
        a_bar: [1.1696,1.0000,0.8618,0.7562,0.6667,0.5933,0.5282,0.4701,0.4187,0.3798,0.3497,0.3223,0.2971,0.2737,0.2523,0.2327],
        b:     [0.5578,0.6514,0.7222,0.7825,0.8126,0.8434,0.8693,0.8910,0.9092,0.9222,0.9319,0.9403,0.9477,0.9544,0.9602,0.9653]
      }
    };
    
    const DCSState = {
      model: Models.ZHL16C_N2,
      frozenPN2_mmHg: null,   // array of 16 PN2 values after pre-breathe
      prebreathe_min: 0
    };
    
    // Exponential N2 washout during pre-breathe (100% O2 at sea level)
    function prebreatheWashout_mmHg(model, t_min, PN2_start_mmHg, PN2_alv_mmHg = 0) {
      return model.halfTimes_min.map(T =>
        PN2_alv_mmHg + (PN2_start_mmHg - PN2_alv_mmHg) * Math.exp(-ln2 * t_min / T)
      );
    }
    
    // Tolerated tissue PN2 ("M-value") at current ambient (returns mmHg)
    function toleratedPN2_mmHg(model, idx, Pamb_mmHg) {
      const Pamb_bar = Pamb_mmHg / MMHG_PER_BAR;
      const M_bar = model.a_bar[idx] + model.b[idx] * Pamb_bar;
      return M_bar * MMHG_PER_BAR;
    }
    
    function riskFromMRatio(R) {
      if (R >= 1.0) return { label: "Exceeds M", cls: "risk-high" };
      if (R >= 0.8) return { label: "Near limit", cls: "risk-med" };
      return { label: "Low", cls: "risk-low" };
    }
    
    function runPrebreatheAndFreeze(PN2_start_mmHg, prebreathe_min) {
      const m = DCSState.model;
      DCSState.prebreathe_min = prebreathe_min;
      DCSState.frozenPN2_mmHg = prebreatheWashout_mmHg(m, prebreathe_min, PN2_start_mmHg, 0);
    }
    
    function computeRiskAtCabin(Pamb_mmHg) {
      if (!DCSState.frozenPN2_mmHg) return [];
      const m = DCSState.model;
      return DCSState.frozenPN2_mmHg.map((PN2, i) => {
        const M = toleratedPN2_mmHg(m, i, Pamb_mmHg);
        const R = PN2 / M;
        return {
          halfTime_min: m.halfTimes_min[i],
          PN2_mmHg: PN2,
          M_mmHg: M,
          ratio: R,
          risk: riskFromMRatio(R)
        };
      });
    }
    
    function renderRiskTable(rows) {
      const tbody = document.getElementById("risk_tbody");
      if (!tbody) return;
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.halfTime_min.toFixed(1)} min</td>
          <td>${r.PN2_mmHg.toFixed(1)}</td>
          <td>${r.M_mmHg.toFixed(1)}</td>
          <td>${(r.ratio*100).toFixed(0)}%</td>
          <td><span class="${r.risk.cls}">${r.risk.label}</span></td>
        </tr>
      `).join("");
    }
  
  function update(){
    console.log("UPDATE CALLED — airAlt_m is", document.getElementById('alt_m').value);

    // Inputs
    const alt_m = clamp(parseFloat(el('alt_m').value), 0, 30000);
    const mode = el('press_profile').value;
    const cabinSet_m = clamp(parseFloat(el('cabin_set_m').value), 0, 5000);
    const dPmax_psi = clamp(parseFloat(el('dPmax_psi').value), 0, 20);

    const o2_mode = el('o2_mode').value;
    const FiO2 = clamp(parseFloat(el('fio2').value), 0.21, 1.0);
    const mask_over_mmHg = clamp(parseFloat(el('mask_over_mmHg').value), 0, 300);
    const PaCO2 = clamp(parseFloat(el('paco2').value), 20, 60);
    const RQ = clamp(parseFloat(el('rq').value), 0.7, 1.0);

    // Ambient
    const Pamb_Pa = isaPressurePa(alt_m);
    const Pamb_mmHg = Pa_to_mmHg(Pamb_Pa);
    const Pamb_psi = Pa_to_psi(Pamb_Pa);

    // Cabin
    const cab = computeCabinPressurePa(alt_m, mode, cabinSet_m, dPmax_psi);
    const Pcab_Pa = cab.Pcabin;
    const Pcab_mmHg = Pa_to_mmHg(Pcab_Pa);
    const Pcab_psi = Pa_to_psi(Pcab_Pa);
    const cab_alt_m = pressureToAltApprox_m(Pcab_Pa);
    const cab_alt_ft = cab_alt_m * FT_PER_M;

    // ΔP
    const dP_Pa = Math.max(0, Pcab_Pa - Pamb_Pa);
    const dP_psi = dP_Pa / PA_PER_PSI;
    const dP_mmhg = dP_Pa / PA_PER_MMHG;

    // Inspired total pressure for gas calcs
    let Pinspired_mmHg = Pcab_mmHg;
    if (o2_mode === "pressure") Pinspired_mmHg = Pcab_mmHg + mask_over_mmHg;

    // Gas/physiology
    const PIO2 = calcPIO2_mmHg(Pinspired_mmHg, FiO2);
    const PAO2 = calcPAO2_mmHg(Pinspired_mmHg, FiO2, PaCO2, RQ);
    const SpO2 = spo2FromPAO2(PAO2);

    // Boyle’s
    const boyleCab = boyleRelVolume(Pcab_mmHg);
    const boyleAmb = boyleRelVolume(Pamb_mmHg);

    // UI writes
    el('alt_ft').textContent = fmtInt(alt_m * FT_PER_M) + " ft";
    el('cabin_set_ft').textContent = fmtInt(cabinSet_m * FT_PER_M) + " ft";
    el('amb_alt_m').textContent = fmtInt(alt_m);
    el('amb_alt_ft2').textContent = fmtInt(alt_m * FT_PER_M) + " ft";

    el('amb_mmhg').textContent = fmt(Pamb_mmHg, 2) + " mmHg";
    el('amb_psi').textContent = fmt(Pamb_psi, 2) + " psi";

    el('cab_mmhg').textContent = fmt(Pcab_mmHg, 2) + " mmHg";
    el('cab_psi').textContent = fmt(Pcab_psi, 2) + " psi";
    el('cab_alt_m').textContent = fmtInt(cab_alt_m);
    el('cab_alt_ft').textContent = fmtInt(cab_alt_ft) + " ft";
    el('segment_badge').textContent = cab.segment;

    el('cab_dp_psi').textContent = fmt(dP_psi, 2) + " psi";
    el('cab_dp_mmhg').textContent = fmt(dP_mmhg, 2) + " mmHg";

    el('pio2').textContent = fmt(PIO2, 1) + " mmHg";
    el('pao2').textContent = fmt(PAO2, 1) + " mmHg";

    el('spo2_val').textContent = fmt(SpO2, 0) + " %";
    el('hypoxia_chip').style.display = (SpO2 < 90) ? "" : "none";

    el('boyle_cabin').textContent = fmt(boyleCab, 2) + " ×";
    el('boyle_ambient').textContent = fmt(boyleAmb, 2) + " ×";
    
    // NEW: animate the Boyle's Law balloons
    updateBoyleVisuals(boyleCab, boyleAmb);
    
    // Mask status
    const status = maskStatusLabel(mask_over_mmHg, o2_mode);
    el('mask_status').innerHTML = `<div class="status-chip"><span class="${status.cls.toLowerCase()}">${status.cls.toUpperCase()}</span> <span>${status.text}</span></div>` +
      ((o2_mode === "pressure" && mask_over_mmHg > 0)
        ? `<div class="muted">Mask overpressure: <span class="strong">${fmt(mask_over_mmHg, 0)} mmHg</span> (${fmt(mask_over_mmHg / 51.7149, 2)} psi)</div>`
        : `<div class="muted">No added mask pressure.</div>`
      );
    
    // ----- Henry's law + DCS (tissue N₂) -----
    const initPreset = document.getElementById('n2_init_preset').value;
    let N2_init_mmHg = parseFloat(document.getElementById('n2_init_mmHg').value);
    
    // Initialize starting tissue PN2 at sea level if needed
    if (initPreset === 'sea_air' || !Number.isFinite(N2_init_mmHg)) {
      N2_init_mmHg = (760 - PH2O_MMHG) * 0.79;
    }
    
    // Read pre-breathe minutes
    const pbNode = document.getElementById('prebreathe_min');
    const prebreathe_min = pbNode ? Number(pbNode.value || 0) : 0;
    
    // Freeze tissues (worst-case) if first run or value changed
    if (!DCSState.frozenPN2_mmHg || DCSState.prebreathe_min !== prebreathe_min) {
      runPrebreatheAndFreeze(N2_init_mmHg, prebreathe_min);
    }
    
    // Choose ambient for M-value comparison (use your cabin ambient if available)
    const Pamb_for_M_mmHg = (typeof Pamb_mmHg === 'number') ? Pamb_mmHg : Pinspired_mmHg;
    
    // Compute per-compartment risks and render
    const rows = computeRiskAtCabin(Pamb_for_M_mmHg);
    renderRiskTable(rows);
    
    // Optional: reflect worst-compartment status in any legacy chip you kept
    const worst = rows.reduce((acc, r) => (r.ratio > (acc?.ratio ?? -1) ? r : acc), null);


  // Mode change: set ΔP by mode, then recompute
  const modeSelect = document.getElementById('press_profile');
  if (modeSelect) {
    modeSelect.addEventListener('change', (e) => {
      setDpMaxForMode(e.target.value); // sets 8 psi for commercial-style, 4 psi for jet
      update();                         // recompute with the new ΔP
    });
  }

  // Wire inputs
  ['alt_m','cabin_set_m','dPmax_psi','o2_mode','fio2','mask_over_mmHg','paco2','rq']
  .forEach(id => {
    const node = document.getElementById(id);
    if (!node) return;
    node.addEventListener('input', update);
    node.addEventListener('change', update);
  });

  const n2Preset = document.getElementById('n2_init_preset');
  if (n2Preset) n2Preset.addEventListener('input', update);
  
  const n2Init = document.getElementById('n2_init_mmHg');
  if (n2Init) n2Init.addEventListener('input', update);
  
  // new: pre-breathe control
  const pbInput = document.getElementById('prebreathe_min');
  if (pbInput) {
    pbInput.addEventListener('input', update);
    pbInput.addEventListener('change', update);
  }

  // Apply mode-specific ΔP before the first render
  (function initDpByMode() {
    const modeSel = document.getElementById('press_profile');
    if (modeSel) setDpMaxForMode(modeSel.value);
  })();

  // Initial render (defaults to Failed mode and FiO2 = 0.21)
  update();
</script>
</body>
</html>
```
